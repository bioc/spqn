---
title: "Spatial quantile normalization for co-expression analysis"
shorttitle: "spqn guide"
author:
  - Yi Wang
  - Kasper D. Hansen
  - Stephanie C. Hicks
package: SpQN
abstract: >
  A guide to using spqn for co-expression analysis
vignette: >
  %\VignetteIndexEntry{spqn User's Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
output:
  BiocStyle::html_document:
    toc_float: true
---

This is a vignettes for examining and visualizing the mean-correlation dependency in a correlation matrix, applying spatial quantile normalization (SpQN) to remove such dependency,as well as examining the normalized the correlation matrix.


# Preliminaries


Let's load the package and some example data.

```{r load, message=FALSE}
library(spqn)
library(spqnData)
library(SummarizedExperiment)
data(gtex.4k)
```

This dataset contains 4,000 genes from GTEx tissue "Adipose Subcutaneous" which we use as exemplar tissue in our preprint CITE. The data is from GTEx v6p. The genes have been restricted to a random sample of 4,000 genes from genes which are
- Either protein-coding or linRNAs
- Expressed (median expression greater than 0 on the $\log_2(\text{RPKM})$ scale

The data is counts (from the GTEx website) which has been transformed to $\log_2(\text{RPKM})$ and 4 principal components have been removed from the data matrix. Removing principal components from the data matrix also results in mean-centering. For this reason we need access to the original log-RPKM values (prior to removing principal components); these are stored in `rowData(gtex.4k)$ave_logrpkm`

First we sort the genes according to expression level and then calculate the correlation matrix
```{r cor_m, message=FALSE}
gtex.4k <- gtex.4k[order(rowData(gtex.4k)$ave_logrpkm),]
cor_m <- cor(t(assay(gtex.4k)))
```

# Examine the mean-correlation relationship in the data

We now recreate a number of diagnostic plots which illustrate the mean-correlation relationship

First, to visualize the mean-correlation relationship, group the genes by expression level and compare the distribution of correlations in each group.
```{r, message = F, fig.width = 4, fig.height = 4}
plot_density_condition_exp(cor_m)
```

Next, to examine the downstream effect of the mean-correlation relationship, compare the separation of signal and background conditional on different expression levels, i.e. compare the distribution of correlations between signals and background in each group. Here we define signal as 0.1% highest absolute correlations in each group.  
```{r, message = F, fig.width = 4, fig.height = 4}
plot_signal_condition_exp(cor_m, 0.1)
```

Then compare the IQR of correlations for genes in each expression level, by gridding the correlation matrix into 10 by 10 bins, and compute the interquartile ranges (IQRs) for each bin, and plot them (the width of each box).
```{r, message=FALSE}
IQR_list <- get_IQR_condition_exp(cor_m, rowData(gtex.4k)$ave_logrpkm)
boxplot(IQR_list$IQR_cor_mat)
```

Furtherly, find the marginal relationship between the lowest of the two expression bins and IQR 
```{r, message = FALSE, fig.width = 4, fig.height = 4}
IQR_unlist <- unlist(lapply(1:10, function(ii) IQR_list$IQR_cor_mat[ii, ii:10]))
plot(rep(IQR_list$grp_mean, times = 1:10),
     IQR_unlist,
     xlab="min(average(log2CPM))", ylab="IQR", cex.lab=1.5, cex.axis=1.2, col="blue")
```

Next, compare the distribution between each bin and the reference bin(here we use the (9,9) bin) by qqplot 
```{r, message = FALSE, fig.width = 3, fig.height = 3}
for(j in 1:10){
    qqplot_condition_exp(cor_m, j, j)
}
```



# To correct the mean-correlation dependency, apply SPQN in the correlation matrix
```{r spqn, message = FALSE, fig.width = 4, fig.height = 4}
cor_m_spqn <- normalize_correlation(cor_m, ngrp=20, size_grp=300, ref_grp=18)
```

# Check the normalization performance, i.e. whether the correlations of genes with different expression levels follow approximately the same distribution.


Compare the distribution of correlations in each expression level
```{r, message = F, fig.width = 4, fig.height = 4}
plot_density_condition_exp(cor_m_spqn)
```

Compare the separation of signal and background conditional on different expression levels
```{r, message = F, fig.width = 4, fig.height = 4}
plot_signal_condition_exp(cor_m_spqn, 0.1)
```

Compare the IQR of correlations for genes in each expression level
```{r, message=FALSE}
IQR_spqn_list <- get_IQR_condition_exp(cor_m_spqn, rowData(gtex.4k)$ave_logrpkm)
boxplot(IQR_spqn_list$IQR_cor_mat)
```


Compare the distribution of each bin and the reference bin, using qqplot
```{r, message = FALSE, fig.width = 3, fig.height = 3}
for(j in 1:10){
    qqplot_condition_exp(cor_m_spqn, j, j)
}
```

Find the marginal relationship between the lowest of the two expression bins and IQR 
```{r, message = FALSE, fig.width = 4, fig.height = 4}
IQR_unlist <- unlist(lapply(1:10, function(ii) IQR_spqnlist$IQR_cor_mat[ii, ii:10]))
plot(rep(IQR_spqn_list$grp_mean, times = 1:10),
     IQR_unlist,
     xlab="min(average(log2CPM))", ylab="IQR", cex.lab=1.5, cex.axis=1.2, col="blue")
```


